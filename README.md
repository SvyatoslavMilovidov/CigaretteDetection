# CigaretteDetection

## Краткое описание

- Необходимо создавать bbox на фотографиях, где есть сигарета. Сигареты могут быть как обычные, так и электронные. Дполнительно необходимо реализовать детекцию на видео.
- Стек: `ultralytics`, `matplotlib`, `numpy`, `opencv-python`, `torch-vision`

## Описание исходны данных

Формирование тренировоного датасета производилось руками (хотя можно было соорудить парсер).

- Количество фотографий в тренировочном датасете - 100
- Тестовый датасет содержит 180 фотографий

Тестовый датасет был получен от компании, поэтому вышло, что количество фотографий в нем превосходит тренировочный. Пример фотографии из тестового датасета ниже:

<img src="readme_imgs\sample_raw_data.jpg" swidth="200" height="300">

## Создание датасета

Для разметки данных использовалась `Roboflow`. Данные размечены под формат YOLO (v8). Фотографии были прмведены к размеру 640\*640.

Ну, здравствуй...

<img src="readme_imgs\sample_ready_data_no_resize.jpg" swidth="300" height="300">
<img src="readme_imgs\sample_ready_data.png" swidth="200" height="300">


## Обучение модели

В качетсве модели была выбрана `YOLOv8n`. [0ссновные характеристики моделей](https://docs.ultralytics.com/models/yolov8/#supported-modes).

Для оценки результата рассмотрим PR-кривую (класс только один, поэтому график подойдёт).

<img src="readme_imgs\PR_curve.png" swidth="200" height="300">

Пример дектции изображения:

<img src="readme_imgs\test_img.jpg" swidth="200" height="300">

Модель может выделять искомые объекты, но с небольшой увернностью. Что можно сделать, чтобы увеличит качество:

- увеличить объем тренировочных данных
- провести более тонкую настройку параметров модели (например, добавить sheduler)
- аугмментировать данные
- использовать предобученную модель


## Обработка видео

Для работы с видео остаётс схожий принцип. Видео делится на кадры и каждый кадр подаётся на предсказание модели. Полученный результат записывается.

Модель детектирует объекты, но есть недостаток точности. Иногда появляются ложные предсказания на объектах схожей формы, поэтому требуется продолжить повышать качество модели.

Фрагмент полученной обработки:

<img src="readme_imgs\ready_video.gif" swidth="200" height="300">

## Создания сервиса

Код сервиса содержится в директории `src`. Описание имеющихся модулей:

- **const.py**: содержит константные значения (пути к файлам)
- **loader.py**: содержит экземпляр класса детектора
- **get_prediction.py**: содержит описание класса детектора
- **detector.py**: точка входа в программу

Класс `CigaretteDetector` из модуля **get_prediction.py** является главным классом и содержит следующие методы:

- `get_predict_for_img()` - создает bbox на изображениях
- `get_predict_for_move()` - создает bbox на видео

В директории **models** расположен файл с весами модели.

В директории **test_data** находятся изображение и видео для тестирования программы.

Для запуска сервиса необходимо ввести команду в терминал в следующем формате:

`python3 detector.pt --source путь_к_файлу`

В результате, в текущей директории будет создан файл с bbox.